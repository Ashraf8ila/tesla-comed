<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tesla-Comed Config Manager</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
        }

        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }

        textarea {
            height: 100px;
            font-family: monospace;
        }

        button {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 10px;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .secondary-btn {
            background-color: #95a5a6;
        }

        .secondary-btn:hover {
            background-color: #7f8c8d;
        }

        .hidden {
            display: none;
        }

        #status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            word-break: break-all;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>Tesla-Comed Config</h1>

        <div class="form-group">
            <label for="githubToken">GitHub Personal Access Token (PAT)</label>
            <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
            <small style="color: #666;">Needs 'repo' scope access.</small>
        </div>

        <!-- Repo details are hardcoded in the script -->
        <div class="form-group hidden">
            <label for="repoOwner">Repo Owner</label>
            <input type="text" id="repoOwner" value="ashraf8ila">
        </div>

        <div class="form-group hidden">
            <label for="repoName">Repo Name</label>
            <input type="text" id="repoName" value="tesla-comed">
        </div>

        <button id="loadBtn" onclick="loadConfig()">Load Current Configuration</button>

        <!-- Share Button -->
        <button id="shareBtn" class="secondary-btn" onclick="openShareModal()">Create Secure Share Link</button>

        <div id="configForm" class="hidden">
            <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">

            <div class="form-group">
                <label for="emails">Email Recipients (comma separated)</label>
                <textarea id="emails"></textarea>
            </div>

            <div class="form-group">
                <label for="alertThreshold">Price Threshold Alert (cents)</label>
                <input type="number" step="0.1" id="alertThreshold">
            </div>

            <div class="form-group">
                <label for="chargeThreshold">Price Threshold Charge (cents)</label>
                <input type="number" step="0.1" id="chargeThreshold">
            </div>

            <button id="saveBtn" onclick="saveConfig()">Save Updates</button>
        </div>

        <div id="status" class="hidden"></div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeShareModal()">&times;</span>
            <h2>Secure Share</h2>
            <p>Encrypt your token with a password and generate a shareable link.</p>
            <div class="form-group">
                <label for="sharePassword">Encryption Password</label>
                <input type="password" id="sharePassword" placeholder="Enter a strong password">
            </div>
            <button onclick="generateSecureLink()">Generate Link</button>
            <div id="shareResult" class="hidden" style="margin-top: 15px;">
                <label>Shareable Link:</label>
                <textarea id="shareLink" readonly style="height: 60px; font-size: 12px;"></textarea>
                <small>Send this link AND the password to the recipient.</small>
            </div>
        </div>
    </div>

    <!-- Decrypt Modal -->
    <div id="decryptModal" class="modal">
        <div class="modal-content">
            <h2>Unlock Secure Link</h2>
            <p>This link is password protected. Enter the password to access.</p>
            <div class="form-group">
                <label for="decryptPassword">Password</label>
                <input type="password" id="decryptPassword">
            </div>
            <button onclick="decryptAndLoad()">Unlock</button>
            <div id="decryptError" class="error hidden" style="margin-top: 10px; padding: 10px;"></div>
        </div>
    </div>

    <script>
        const CONFIG_PATH = 'src/config.py';
        const REPO_OWNER = 'ashraf8ila';
        const REPO_NAME = 'tesla-comed';

        // --- Initialization ---
        window.onload = async function () {
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');
            const encryptedData = urlParams.get('encrypted');

            if (urlToken) {
                // Direct token (legacy/insecure)
                document.getElementById('githubToken').value = urlToken;
                loadConfig();
            } else if (encryptedData) {
                // Encrypted token - show decrypt modal
                document.getElementById('decryptModal').style.display = 'block';
                window.encryptedTokenData = encryptedData;
            } else {
                // Check local storage
                const savedToken = localStorage.getItem('github_pat');
                if (savedToken) {
                    document.getElementById('githubToken').value = savedToken;
                }
            }
        }

        // --- Core Logic ---
        function showStatus(message, type) {
            const el = document.getElementById('status');
            el.textContent = message;
            el.className = type;
            el.style.display = 'block';
        }

        async function loadConfig() {
            const token = document.getElementById('githubToken').value.trim();

            if (!token) {
                showStatus('Please enter a GitHub PAT', 'error');
                return;
            }

            localStorage.setItem('github_pat', token);

            document.getElementById('loadBtn').disabled = true;
            document.body.classList.add('loading');
            showStatus('Loading configuration...', 'success');

            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${CONFIG_PATH}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3.raw'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch config: ${response.statusText}`);
                }

                const text = await response.text();
                parseConfig(text);

                document.getElementById('configForm').style.display = 'block';
                showStatus('Configuration loaded successfully', 'success');
            } catch (error) {
                console.error(error);
                showStatus(error.message, 'error');
            } finally {
                document.getElementById('loadBtn').disabled = false;
                document.body.classList.remove('loading');
            }
        }

        function parseConfig(text) {
            const emailRegex = /CHARGE_EMAIL_RECIPIENTS\s*=\s*\[(.*?)\]/s;
            const alertRegex = /PRICE_THRESHOLD_ALERT\s*=\s*([0-9.]+)/;
            const chargeRegex = /PRICE_THRESHOLD_CHARGE\s*=\s*([0-9.]+)/;

            const emailMatch = text.match(emailRegex);
            if (emailMatch) {
                const rawList = emailMatch[1];
                const emails = rawList.split(',')
                    .map(s => s.trim().replace(/^['"]|['"]$/g, ''))
                    .filter(s => s);
                document.getElementById('emails').value = emails.join(', ');
            }

            const alertMatch = text.match(alertRegex);
            if (alertMatch) {
                document.getElementById('alertThreshold').value = alertMatch[1];
            }

            const chargeMatch = text.match(chargeRegex);
            if (chargeMatch) {
                document.getElementById('chargeThreshold').value = chargeMatch[1];
            }
        }

        async function saveConfig() {
            const token = document.getElementById('githubToken').value.trim();
            const emails = document.getElementById('emails').value;
            const alertThreshold = document.getElementById('alertThreshold').value;
            const chargeThreshold = document.getElementById('chargeThreshold').value;

            document.getElementById('saveBtn').disabled = true;
            document.body.classList.add('loading');
            showStatus('Dispatching update event...', 'success');

            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        event_type: 'update-config',
                        client_payload: {
                            emails: emails,
                            alert_threshold: alertThreshold,
                            charge_threshold: chargeThreshold
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`Failed to dispatch event: ${response.statusText}`);
                }

                showStatus('Update request sent successfully! Check the "Actions" tab in your repo.', 'success');
            } catch (error) {
                console.error(error);
                showStatus(error.message, 'error');
            } finally {
                document.getElementById('saveBtn').disabled = false;
                document.body.classList.remove('loading');
            }
        }

        // --- Encryption / Decryption Logic (Web Crypto API) ---

        function openShareModal() {
            const token = document.getElementById('githubToken').value.trim();
            if (!token) {
                alert("Please enter or load a token first.");
                return;
            }
            document.getElementById('shareModal').style.display = 'block';
        }

        function closeShareModal() {
            document.getElementById('shareModal').style.display = 'none';
        }

        async function generateSecureLink() {
            const token = document.getElementById('githubToken').value.trim();
            const password = document.getElementById('sharePassword').value;

            if (!password) {
                alert("Please enter a password.");
                return;
            }

            try {
                const encryptedData = await encryptToken(token, password);
                const baseUrl = window.location.href.split('?')[0];
                const link = `${baseUrl}?encrypted=${encodeURIComponent(encryptedData)}`;

                document.getElementById('shareLink').value = link;
                document.getElementById('shareResult').style.display = 'block';
            } catch (e) {
                console.error(e);
                alert("Encryption failed: " + e.message);
            }
        }

        async function decryptAndLoad() {
            const password = document.getElementById('decryptPassword').value;
            const encryptedData = window.encryptedTokenData;

            try {
                const token = await decryptToken(encryptedData, password);
                if (token) {
                    document.getElementById('githubToken').value = token;
                    document.getElementById('decryptModal').style.display = 'none';
                    loadConfig();
                }
            } catch (e) {
                console.error(e);
                const errDiv = document.getElementById('decryptError');
                errDiv.textContent = "Incorrect password or invalid data.";
                errDiv.style.display = 'block';
            }
        }

        // Crypto Helpers
        async function encryptToken(msg, password) {
            const enc = new TextEncoder();
            const salt = window.crypto.getRandomValues(new Uint8Array(16));
            const iv = window.crypto.getRandomValues(new Uint8Array(12));

            const keyMaterial = await window.crypto.subtle.importKey(
                "raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]
            );

            const key = await window.crypto.subtle.deriveKey(
                { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
                keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt"]
            );

            const encrypted = await window.crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv }, key, enc.encode(msg)
            );

            // Combine salt + iv + ciphertext
            const buffer = new Uint8Array(salt.byteLength + iv.byteLength + encrypted.byteLength);
            buffer.set(salt, 0);
            buffer.set(iv, salt.byteLength);
            buffer.set(new Uint8Array(encrypted), salt.byteLength + iv.byteLength);

            // Convert to Base64
            return btoa(String.fromCharCode(...buffer));
        }

        async function decryptToken(base64Data, password) {
            const enc = new TextEncoder();
            const rawData = atob(base64Data);
            const buffer = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; i++) {
                buffer[i] = rawData.charCodeAt(i);
            }

            const salt = buffer.slice(0, 16);
            const iv = buffer.slice(16, 28);
            const data = buffer.slice(28);

            const keyMaterial = await window.crypto.subtle.importKey(
                "raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]
            );

            const key = await window.crypto.subtle.deriveKey(
                { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
                keyMaterial, { name: "AES-GCM", length: 256 }, false, ["decrypt"]
            );

            const decrypted = await window.crypto.subtle.decrypt(
                { name: "AES-GCM", iv: iv }, key, data
            );

            return new TextDecoder().decode(decrypted);
        }
    </script>

</body>

</html>