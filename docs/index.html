<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tesla-Comed Config Manager</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
        }

        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }

        textarea {
            height: 100px;
            font-family: monospace;
        }

        button {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 10px;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .secondary-btn {
            background-color: #95a5a6;
        }

        .secondary-btn:hover {
            background-color: #7f8c8d;
        }

        .hidden {
            display: none;
        }

        #status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            word-break: break-all;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Existing Emails List */
        .email-list {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .email-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            color: #555;
        }

        .email-item:last-child {
            border-bottom: none;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>Tesla-Comed Config</h1>

        <div class="form-group">
            <label for="githubToken">GitHub Personal Access Token (PAT)</label>
            <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
            <small style="color: #666;">Needs 'repo' scope access.</small>
        </div>

        <!-- Repo details are hardcoded in the script -->
        <div class="form-group hidden">
            <label for="repoOwner">Repo Owner</label>
            <input type="text" id="repoOwner" value="ashraf8ila">
        </div>

        <div class="form-group hidden">
            <label for="repoName">Repo Name</label>
            <input type="text" id="repoName" value="tesla-comed">
        </div>

        <button id="loadBtn" onclick="loadConfig()">Load Current Configuration</button>

        <!-- Share Button -->
        <button id="shareBtn" class="secondary-btn" onclick="openShareModal()">Create Secure Share Link</button>

        <div id="configForm" class="hidden">
            <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">

            <div class="form-group hidden">
                <label>Current Email Recipients</label>
                <div id="emailList" class="email-list">
                    <!-- Emails populated here -->
                    <div class="email-item">Managed via GitHub Secrets</div>
                </div>

                <label for="newEmail" style="margin-top: 15px;">Add New Email</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="newEmail" placeholder="user@example.com" disabled>
                </div>
            </div>

            <div class="form-group">
                <label for="alertThreshold">Price Threshold Alert (cents)</label>
                <input type="number" step="0.1" id="alertThreshold">
            </div>

            <div class="form-group">
                <label for="chargeThreshold">Price Threshold Charge (cents)</label>
                <input type="number" step="0.1" id="chargeThreshold">
            </div>

            <div class="form-group">
                <label for="cooldownMinutes">Cooldown Minutes</label>
                <input type="number" id="cooldownMinutes" min="0">
                <small style="color: #666;">Minimum time between notifications.</small>
            </div>

            <button id="saveBtn" onclick="saveConfig()">Save Updates</button>
        </div>

        <div id="status" class="hidden"></div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeShareModal()">&times;</span>
            <h2>Secure Share</h2>
            <p>Encrypt your token with a password and generate a shareable link.</p>
            <div class="form-group">
                <label for="sharePassword">Encryption Password</label>
                <input type="password" id="sharePassword" placeholder="Enter a strong password">
            </div>
            <button onclick="generateSecureLink()">Generate Link</button>
            <div id="shareResult" class="hidden" style="margin-top: 15px;">
                <label>Shareable Link:</label>
                <textarea id="shareLink" readonly style="height: 60px; font-size: 12px;"></textarea>
                <small>Send this link AND the password to the recipient.</small>
            </div>
        </div>
    </div>

    <!-- Decrypt Modal -->
    <div id="decryptModal" class="modal">
        <div class="modal-content">
            <h2>Unlock Secure Link</h2>
            <p>This link is password protected. Enter the password to access.</p>
            <div class="form-group">
                <label for="decryptPassword">Password</label>
                <input type="password" id="decryptPassword">
            </div>
            <button onclick="decryptAndLoad()">Unlock</button>
            <div id="decryptError" class="error hidden" style="margin-top: 10px; padding: 10px;"></div>
        </div>
    </div>

    <script>
        const CONFIG_PATH = 'src/config.py';
        const REPO_OWNER = 'ashraf8ila';
        const REPO_NAME = 'tesla-comed';

        // --- Initialization ---
        window.onload = async function () {
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');
            const encryptedData = urlParams.get('encrypted');

            if (urlToken) {
                // Direct token (legacy/insecure)
                document.getElementById('githubToken').value = urlToken;
                loadConfig();
            } else if (encryptedData) {
                // Encrypted token - show decrypt modal
                document.getElementById('decryptModal').style.display = 'block';
                window.encryptedTokenData = encryptedData;
            } else {
                // Check local storage
                const savedToken = localStorage.getItem('github_pat');
                if (savedToken) {
                    document.getElementById('githubToken').value = savedToken;
                }
            }
        }

        // --- Core Logic ---
        function showStatus(message, type) {
            const el = document.getElementById('status');
            el.textContent = message;
            el.className = type;
            el.style.display = 'block';
        }

        async function loadConfig() {
            const token = document.getElementById('githubToken').value.trim();

            if (!token) {
                showStatus('Please enter a GitHub PAT', 'error');
                return;
            }

            localStorage.setItem('github_pat', token);

            document.getElementById('loadBtn').disabled = true;
            document.body.classList.add('loading');
            showStatus('Loading configuration...', 'success');

            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${CONFIG_PATH}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3.raw'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch config: ${response.statusText}`);
                }

                const text = await response.text();
                parseConfig(text);

                document.getElementById('configForm').style.display = 'block';
                showStatus('Configuration loaded successfully', 'success');
            } catch (error) {
                console.error(error);
                showStatus(error.message, 'error');
            } finally {
                document.getElementById('loadBtn').disabled = false;
                document.body.classList.remove('loading');
            }
        }

        function parseConfig(text) {
            const emailRegex = /CHARGE_EMAIL_RECIPIENTS\s*=\s*\[(.*?)\]/s;
            const alertRegex = /PRICE_THRESHOLD_ALERT\s*=\s*([0-9.]+)/;
            const chargeRegex = /PRICE_THRESHOLD_CHARGE\s*=\s*([0-9.]+)/;

            const emailMatch = text.match(emailRegex);
            if (emailMatch) {
                const rawList = emailMatch[1];
                const emails = rawList.split(',')
                    .map(s => s.trim().replace(/^['"]|['"]$/g, ''))
                    .filter(s => s);

                // Populate read-only list
                const listEl = document.getElementById('emailList');
                listEl.innerHTML = '';
                if (emails.length === 0) {
                    listEl.innerHTML = '<div class="email-item">No emails configured</div>';
                } else {
                    emails.forEach(email => {
                        const div = document.createElement('div');
                        div.className = 'email-item';
                        div.textContent = email;
                        listEl.appendChild(div);
                    });
                }
            }

            const alertMatch = text.match(alertRegex);
            if (alertMatch) {
                document.getElementById('alertThreshold').value = alertMatch[1];
            }

            const chargeMatch = text.match(chargeRegex);
            if (chargeMatch) {
                document.getElementById('chargeThreshold').value = chargeMatch[1];
            }
        }

        async function saveConfig() {
            const token = document.getElementById('githubToken').value.trim();
            const newEmail = document.getElementById('newEmail').value.trim();
            const alertThreshold = document.getElementById('alertThreshold').value;
            const chargeThreshold = document.getElementById('chargeThreshold').value;

            // Determine who is making the change
            let updatedBy = 'Owner (Direct Token)';
            if (window.securePassword) {
                updatedBy = window.securePassword;
            }

            document.getElementById('saveBtn').disabled = true;
            document.body.classList.add('loading');
            showStatus('Dispatching update event...', 'success');

            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        event_type: 'update-config',
                        client_payload: {
                            add_email: newEmail, // Only sending new email
                            alert_threshold: alertThreshold,
                            charge_threshold: chargeThreshold,
                            cooldown_minutes: document.getElementById('cooldownMinutes').value,
                            updated_by: updatedBy
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`Failed to dispatch event: ${response.statusText}`);
                }

                let msg = 'Update request sent! Check your repo Actions.';
                if (newEmail) {
                    msg += ' (New email added)';
                    document.getElementById('newEmail').value = ''; // Clear input on success
                }
                showStatus(msg, 'success');

            } catch (error) {
                console.error(error);
                showStatus(error.message, 'error');
            } finally {
                document.getElementById('saveBtn').disabled = false;
                document.body.classList.remove('loading');
            }
        }

        // --- Encryption / Decryption Logic (Web Crypto API) ---

        function openShareModal() {
            const token = document.getElementById('githubToken').value.trim();
            if (!token) {
                alert("Please enter or load a token first.");
                return;
            }
            document.getElementById('shareModal').style.display = 'block';
        }

        function closeShareModal() {
            document.getElementById('shareModal').style.display = 'none';
        }

        async function generateSecureLink() {
            const token = document.getElementById('githubToken').value.trim();
            const password = document.getElementById('sharePassword').value;

            if (!password) {
                alert("Please enter a password.");
                return;
            }

            try {
                const encryptedData = await encryptToken(token, password);
                const baseUrl = window.location.href.split('?')[0];
                const link = `${baseUrl}?encrypted=${encodeURIComponent(encryptedData)}`;

                document.getElementById('shareLink').value = link;
                document.getElementById('shareResult').style.display = 'block';
            } catch (e) {
                console.error(e);
                alert("Encryption failed: " + e.message);
            }
        }

        function setSecureMode() {
            // Hide sensitive fields
            document.getElementById('githubToken').closest('.form-group').style.display = 'none';
            document.getElementById('emailList').closest('.form-group').querySelector('label').style.display = 'none';
            document.getElementById('emailList').style.display = 'none';
            document.getElementById('shareBtn').style.display = 'none';

            // Add a visual indicator
            const container = document.querySelector('.container');
            const badge = document.createElement('div');
            badge.innerHTML = 'ðŸ”’ Secure Shared Mode';
            badge.style.cssText = 'background:#e8f5e9; color:#2e7d32; padding:10px; margin-bottom:20px; text-align:center; font-weight:bold; border-radius:4px;';
            container.insertBefore(badge, container.querySelector('h1').nextSibling);
        }

        async function decryptAndLoad() {
            const password = document.getElementById('decryptPassword').value;
            const encryptedData = window.encryptedTokenData;

            try {
                const token = await decryptToken(encryptedData, password);
                if (token) {
                    document.getElementById('githubToken').value = token;
                    document.getElementById('decryptModal').style.display = 'none';

                    window.securePassword = password;
                    setSecureMode();

                    loadConfig();
                }
            } catch (e) {
                console.error(e);
                const errDiv = document.getElementById('decryptError');
                errDiv.textContent = "Incorrect password or invalid data.";
                errDiv.style.display = 'block';
            }
        }

        // Crypto Helpers
        async function encryptToken(msg, password) {
            const enc = new TextEncoder();
            const salt = window.crypto.getRandomValues(new Uint8Array(16));
            const iv = window.crypto.getRandomValues(new Uint8Array(12));

            const keyMaterial = await window.crypto.subtle.importKey(
                "raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]
            );

            const key = await window.crypto.subtle.deriveKey(
                { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
                keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt"]
            );

            const encrypted = await window.crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv }, key, enc.encode(msg)
            );

            // Combine salt + iv + ciphertext
            const buffer = new Uint8Array(salt.byteLength + iv.byteLength + encrypted.byteLength);
            buffer.set(salt, 0);
            buffer.set(iv, salt.byteLength);
            buffer.set(new Uint8Array(encrypted), salt.byteLength + iv.byteLength);

            // Convert to Base64
            return btoa(String.fromCharCode(...buffer));
        }

        async function decryptToken(base64Data, password) {
            const enc = new TextEncoder();
            const rawData = atob(base64Data);
            const buffer = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; i++) {
                buffer[i] = rawData.charCodeAt(i);
            }

            const salt = buffer.slice(0, 16);
            const iv = buffer.slice(16, 28);
            const data = buffer.slice(28);

            const keyMaterial = await window.crypto.subtle.importKey(
                "raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]
            );

            const key = await window.crypto.subtle.deriveKey(
                { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
                keyMaterial, { name: "AES-GCM", length: 256 }, false, ["decrypt"]
            );

            const decrypted = await window.crypto.subtle.decrypt(
                { name: "AES-GCM", iv: iv }, key, data
            );

            return new TextDecoder().decode(decrypted);
        }
    </script>
    <script>
        // --- System Status & Cooldown Logic ---
        const STATE_PATH = 'state.json';

        async function loadState(token) {
            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${STATE_PATH}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3.raw'
                    }
                });

                if (!response.ok) {
                    console.warn(`Failed to fetch state: ${response.statusText}`);
                    // Don't crash the whole app, just don't show status
                    return;
                }

                const text = await response.text();
                const state = JSON.parse(text);
                renderSystemStatus(state);
            } catch (error) {
                console.error("Error loading state:", error);
            }
        }

        function renderSystemStatus(state) {
            const container = document.querySelector('.container');
            const header = container.querySelector('h1');

            // Check if status section already exists
            let statusDiv = document.getElementById('systemStatus');
            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.id = 'systemStatus';
                statusDiv.style.cssText = 'background:#f0f7fb; border-left: 4px solid #3498db; padding:15px; margin-bottom:20px; border-radius:4px;';
                header.parentNode.insertBefore(statusDiv, header.nextSibling);
            }

            const price = state.last_detected_price !== undefined ? `${state.last_detected_price}Â¢` : 'Unknown';
            const priceTime = state.last_price_time ? new Date(state.last_price_time).toLocaleTimeString() : '';
            const charging = state.charging_recommended
                ? '<span style="color:green; font-weight:bold">âš¡ CHARGING (Active)</span>'
                : '<span style="color:#7f8c8d; font-weight:bold">IDLE (Stopped)</span>';
            const lastNotif = state.last_notification_time ? new Date(state.last_notification_time * 1000).toLocaleString() : 'Never';

            statusDiv.innerHTML = `
                <h3 style="margin-top:0; color:#2c3e50;">System Status</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><strong>Current Price:</strong> <span id="sysPrice">${price}</span> <small style="color:#666" id="sysPriceTime">(${priceTime})</small></div>
                    <div><strong>Charging State:</strong> ${charging}</div>
                    <div style="grid-column: span 2;"><strong>Last Notification:</strong> ${lastNotif}</div>
                    <div style="grid-column: span 2; margin-top:5px; display: flex; gap: 10px; align-items: center;">
                        <button onclick="checkLivePrice()" style="width:auto; padding:5px 10px; font-size:12px; background:#27ae60;">Check Live Price (ComEd API)</button>
                        <button onclick="sendTestEmail()" id="testEmailBtn" style="width:auto; padding:5px 10px; font-size:12px; background:#8e44ad;">Send Test Email</button>
                        <span id="livePriceResult" style="margin-left:10px; font-weight:bold;"></span>
                    </div>
                </div>
            `;
        }

        // Hook into existing loadConfig to also load state
        const originalLoadConfig = typeof loadConfig !== 'undefined' ? loadConfig : null;
        if (originalLoadConfig) {
            window.loadConfig = async function () {
                await originalLoadConfig();
                const token = document.getElementById('githubToken').value.trim();
                if (token) {
                    loadState(token);
                }
            }
        }

        // Hook into parseConfig to handle Cooldown
        const originalParseConfig = typeof parseConfig !== 'undefined' ? parseConfig : null;
        if (originalParseConfig) {
            window.parseConfig = function (text) {
                originalParseConfig(text);

                const cooldownRegex = /COOLDOWN_MINUTES\s*=\s*([0-9]+)/;
                const match = text.match(cooldownRegex);
                if (match) {
                    // Ensure element exists (it might not be in the HTML yet if we haven't added it)
                    // But we should add it to the HTML structure first. 
                    // See below for injecting the inputfield.
                    const cooldownInput = document.getElementById('cooldownMinutes');
                    if (cooldownInput) {
                        cooldownInput.value = match[1];
                    }
                }
            }
        }

        // --- Manual Price Check ---
        async function checkLivePrice() {
            const btn = document.querySelector('button[onclick="checkLivePrice()"]');
            const resultSpan = document.getElementById('livePriceResult');

            btn.disabled = true;
            btn.textContent = "Checking...";
            resultSpan.textContent = "";

            try {
                // ComEd API (Public)
                // Note: Fetching from browser might hit CORS issues depending on ComEd's headers.
                // If it fails, users might need a CORS proxy or just rely on the backend.
                // However, ComEd's API is generally open.
                const response = await fetch('https://hourlypricing.comed.com/api?type=currenthouraverage');
                if (!response.ok) throw new Error("Network response was not ok");

                const data = await response.json();
                if (data && data.length > 0) {
                    const price = data[0].price;
                    const timestamp = new Date(parseInt(data[0].millisUTC)).toLocaleTimeString();

                    resultSpan.innerHTML = `<span style="color:#2980b9">Live: ${price}Â¢</span> <small>(${timestamp})</small>`;

                    // Optional: Update the main display too?
                    // document.getElementById('sysPrice').textContent = price + 'Â¢';
                } else {
                    throw new Error("No data returned");
                }
            } catch (error) {
                console.error("Live check failed:", error);
                resultSpan.innerHTML = `<span style="color:#c0392b">Error: ${error.message}. (CORS?)</span>`;
            } finally {
                btn.disabled = false;
                btn.textContent = "Check Live Price (ComEd API)";
            }
        }

        // --- Test Email Trigger ---
        async function sendTestEmail() {
            const token = document.getElementById('githubToken').value.trim();
            if (!token) {
                alert("Please enter a GitHub Token to send emails.");
                return;
            }

            // Try to get the live price if available, otherwise fallback to the system price
            const resultSpan = document.getElementById('livePriceResult').innerText;
            const sysPriceText = document.getElementById('sysPrice').innerText;

            let currentPrice = sysPriceText.replace('Â¢', '');

            // Basic parsing if live price is shown (e.g. "Live: 1.5Â¢ (12:00 PM)")
            if (resultSpan && resultSpan.includes('Live:')) {
                const match = resultSpan.match(/Live:\s*([0-9.]+)Â¢/);
                if (match) {
                    currentPrice = match[1];
                }
            }

            const btn = document.getElementById('testEmailBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = "Sending...";

            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        event_type: 'test-email',
                        client_payload: {
                            price: currentPrice
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`Failed to dispatch event: ${response.statusText}`);
                }
                alert("Test email command sent! Check your inbox shortly.");
            } catch (error) {
                console.error("Test email failed:", error);
                alert("Failed to send test email: " + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

    </script>

</body>

</html>